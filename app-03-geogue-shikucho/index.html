<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>市区町村クイズ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        .font-rounded {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        /* -- 画面切り替えのアニメーション -- */
        .screen {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }
        
        /* -- 新しい日本地図デザインのCSS -- */
        .japan-map-grid {
            display: grid;
            grid-template-columns: repeat(30, 1fr);
            grid-template-rows: repeat(28, 1fr);
            width: 100%;
            max-width: 800px; /* サイズを小さく */
            height: 70vh;    /* サイズを小さく */
            gap: 4px;
        }

        .prefecture-btn {
            background-color: #ffffff;
            border: 1px solid #d1d1d1;
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 13px; /* フォントサイズを大きく */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 2px;
        }

        .prefecture-btn:hover {
            transform: translateY(-2px);
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        #hokkaido { grid-area: 1 / 26 / 5 / 31; }
        #aomori   { grid-area: 6 / 26 / 8 / 30; }
        #iwate    { grid-area: 8 / 28 / 11 / 30; }
        #akita    { grid-area: 8 / 26 / 11 / 28; }
        #miyagi   { grid-area: 11 / 28 / 14 / 30; }
        #yamagata { grid-area: 11 / 26 / 14 / 28; }
        #fukushima{ grid-area: 14 / 26 / 16 / 30; }
        #ibaraki  { grid-area: 16 / 28 / 19 / 30; }
        #tochigi  { grid-area: 16 / 26 / 18 / 28; }
        #gunma    { grid-area: 16 / 24 / 18 / 26; }
        #saitama  { grid-area: 18 / 24 / 20 / 26; }
        #chiba    { grid-area: 19 / 28 / 22 / 30; }
        #tokyo    { grid-area: 18 / 26 / 20 / 28; }
        #kanagawa { grid-area: 20 / 24 / 22 / 26; }
        #niigata  { grid-area: 14 / 22 / 16 / 26; }
        #toyama   { grid-area: 14 / 20 / 16 / 22; }
        #ishikawa { grid-area: 14 / 18 / 16 / 20; }
        #fukui    { grid-area: 16 / 18 / 18 / 20; }
        #nagano   { grid-area: 16 / 22 / 18 / 24; }
        #yamanashi{ grid-area: 18 / 22 / 20 / 24; }
        #shizuoka { grid-area: 20 / 22 / 22 / 24; }
        #aichi    { grid-area: 20 / 20 / 22 / 22; }
        #gifu     { grid-area: 16 / 20 / 20 / 22; }
        #mie      { grid-area: 20 / 18 / 23 / 20; }
        #shiga    { grid-area: 18 / 18 / 20 / 20; }
        #kyoto    { grid-area: 16 / 16 / 18 / 18; }
        #nara     { grid-area: 20 / 16 / 22 / 18; }
        #wakayama { grid-area: 22 / 16 / 24 / 18; }
        #osaka    { grid-area: 18 / 16 / 20 / 18; }
        #hyogo    { grid-area: 16 / 14 / 20 / 16; }
        #tottori  { grid-area: 16 / 12 / 18 / 14; }
        #okayama  { grid-area: 18 / 12 / 20 / 14; }
        #shimane  { grid-area: 16 / 10 / 18 / 12; }
        #hiroshima{ grid-area: 18 / 10 / 20 / 12; }
        #yamaguchi{ grid-area: 18 / 8 / 20 / 10; }
        #kagawa   { grid-area: 21 / 13 / 23 / 15; }
        #tokushima{ grid-area: 23 / 13 / 25 / 15; }
        #ehime    { grid-area: 21 / 10 / 23 / 13; }
        #kochi    { grid-area: 23 / 10 / 25 / 13; }
        #fukuoka  { grid-area: 18 / 5 / 20 / 7; }
        #oita     { grid-area: 20 / 5 / 22 / 7; }
        #saga     { grid-area: 18 / 3 / 20 / 5; }
        #nagasaki { grid-area: 18 / 1 / 20 / 3; }
        #kumamoto { grid-area: 20 / 3 / 22 / 5; }
        #miyazaki { grid-area: 22 / 5 / 24 / 7; }
        #kagoshima{ grid-area: 22 / 3 / 24 / 5; }
        #okinawa  { grid-area: 25 / 1 / 27 / 3; }


        /* -- 回答後のボタンスタイル -- */
        .prefecture-btn.correct {
            background-color: #4ade80 !important; /* green-400 */
            color: white !important;
            transform: scale(1.05);
            border-color: #2f855a !important;
        }
        .prefecture-btn.incorrect {
            background-color: #f87171 !important; /* red-400 */
            color: white !important;
            opacity: 0.6;
            border-color: #c53030 !important;
        }
        .prefecture-btn.disabled {
            pointer-events: none;
        }

        /* -- 正解・不正解フィードバックのスタイル -- */
        #feedback-message {
            transition: all 0.2s ease-in-out;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: white;
            font-size: 1.5em; 
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        #feedback-message.correct-feedback {
            background-color: #4ade80; /* green-400 */
        }
        #feedback-message.incorrect-feedback {
            background-color: #f87171; /* red-400 */
        }

        /* -- noUiSliderのスタイル調整 -- */
        .noUi-connect { background: #3b82f6; } /* blue-500 */
        .noUi-handle { border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .noUi-handle:focus { outline: none; }
        .noUi-target { border-radius: 9999px; }
        .noUi-horizontal { height: 10px; }
        .noUi-horizontal .noUi-handle { width: 24px; height: 24px; right: -12px; top: -7px; }

        /* -- ローディングスピナー -- */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto relative">

        <div id="loading-screen" class="screen text-center">
            <div class="loader inline-block"></div>
            <p class="mt-4 text-gray-600">市区町村データを読み込み中...</p>
        </div>

        <div id="settings-screen" class="screen hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                <h1 class="text-2xl md:text-3xl font-bold text-center mb-6 font-rounded">市区町村クイズ 設定</h1>

                <div class="space-y-8">
                    <div>
                        <label class="block text-lg font-semibold mb-3 text-gray-700">出題数</label>
                        <div class="flex justify-center space-x-2">
                            <button data-questions="10" class="setting-btn question-count-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-full font-semibold">10問</button>
                            <button data-questions="20" class="setting-btn question-count-btn bg-blue-500 text-white px-4 py-2 rounded-full font-semibold">20問</button>
                            <button data-questions="50" class="setting-btn question-count-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-full font-semibold">50問</button>
                        </div>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold mb-4 text-gray-700">出題範囲の絞り込み</h2>
                        <div class="space-y-6">
                            <div>
                                <div class="flex justify-between items-baseline mb-2">
                                    <label class="font-semibold">面積 (km²)</label>
                                    <span id="area-range-label" class="text-sm text-gray-600"></span>
                                </div>
                                <div id="area-slider" class="mx-2"></div>
                            </div>
                            <div>
                                <div class="flex justify-between items-baseline mb-2">
                                    <label class="font-semibold">人口 (人)</label>
                                    <span id="population-range-label" class="text-sm text-gray-600"></span>
                                </div>
                                <div id="population-slider" class="mx-2"></div>
                            </div>
                            <div>
                                <div class="flex justify-between items-baseline mb-2">
                                    <label class="font-semibold">人口密度 (人/km²)</label>
                                    <span id="density-range-label" class="text-sm text-gray-600"></span>
                                </div>
                                <div id="density-slider" class="mx-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-10 text-center">
                    <p class="mb-2 text-gray-600">対象市区町村数: <span id="filtered-cities-count" class="font-bold text-lg">0</span></p>
                    <button id="start-quiz-btn" class="w-full max-w-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                        クイズ開始
                    </button>
                </div>
            </div>
        </div>

        <div id="quiz-screen" class="screen hidden">
             <div class="bg-white p-4 md:p-8 rounded-2xl shadow-lg">
                <div class="mb-4 flex justify-between items-center">
                    <h2 id="progress-indicator" class="text-lg font-bold font-rounded">1問目 / 20問</h2>
                    <div id="feedback-message" class="text-xl font-bold text-center h-12"></div>
                </div>

                <p class="text-center text-2xl md:text-4xl font-bold my-6 h-20 flex items-center justify-center">
                    <span id="city-name-question" class="font-rounded"></span>はどの都道府県？
                </p>

                <div class="japan-map-grid">
                    <div id="hokkaido"  class="prefecture-btn" data-prefecture="北海道">北海道</div>
                    <div id="aomori"    class="prefecture-btn" data-prefecture="青森県">青森</div><div id="iwate" class="prefecture-btn" data-prefecture="岩手県">岩手</div>
                    <div id="miyagi"    class="prefecture-btn" data-prefecture="宮城県">宮城</div><div id="akita" class="prefecture-btn" data-prefecture="秋田県">秋田</div>
                    <div id="yamagata"  class="prefecture-btn" data-prefecture="山形県">山形</div><div id="fukushima" class="prefecture-btn" data-prefecture="福島県">福島</div>
                    <div id="ibaraki"   class="prefecture-btn" data-prefecture="茨城県">茨城</div><div id="tochigi" class="prefecture-btn" data-prefecture="栃木県">栃木</div>
                    <div id="gunma"     class="prefecture-btn" data-prefecture="群馬県">群馬</div><div id="saitama" class="prefecture-btn" data-prefecture="埼玉県">埼玉</div>
                    <div id="chiba"     class="prefecture-btn" data-prefecture="千葉県">千葉</div><div id="tokyo" class="prefecture-btn" data-prefecture="東京都">東京</div>
                    <div id="kanagawa"  class="prefecture-btn" data-prefecture="神奈川県">神奈川</div><div id="niigata" class="prefecture-btn" data-prefecture="新潟県">新潟</div>
                    <div id="toyama"    class="prefecture-btn" data-prefecture="富山県">富山</div><div id="ishikawa" class="prefecture-btn" data-prefecture="石川県">石川</div>
                    <div id="fukui"     class="prefecture-btn" data-prefecture="福井県">福井</div><div id="yamanashi" class="prefecture-btn" data-prefecture="山梨県">山梨</div>
                    <div id="nagano"    class="prefecture-btn" data-prefecture="長野県">長野</div><div id="gifu"      class="prefecture-btn" data-prefecture="岐阜県">岐阜</div>
                    <div id="shizuoka"  class="prefecture-btn" data-prefecture="静岡県">静岡</div><div id="aichi" class="prefecture-btn" data-prefecture="愛知県">愛知</div>
                    <div id="mie"       class="prefecture-btn" data-prefecture="三重県">三重</div><div id="shiga" class="prefecture-btn" data-prefecture="滋賀県">滋賀</div>
                    <div id="kyoto"     class="prefecture-btn" data-prefecture="京都府">京都</div><div id="osaka" class="prefecture-btn" data-prefecture="大阪府">大阪</div>
                    <div id="hyogo"     class="prefecture-btn" data-prefecture="兵庫県">兵庫</div><div id="nara"      class="prefecture-btn" data-prefecture="奈良県">奈良</div>
                    <div id="wakayama"  class="prefecture-btn" data-prefecture="和歌山県">和歌山</div><div id="tottori" class="prefecture-btn" data-prefecture="鳥取県">鳥取</div>
                    <div id="shimane"   class="prefecture-btn" data-prefecture="島根県">島根</div><div id="okayama" class="prefecture-btn" data-prefecture="岡山県">岡山</div>
                    <div id="hiroshima" class="prefecture-btn" data-prefecture="広島県">広島</div><div id="yamaguchi" class="prefecture-btn" data-prefecture="山口県">山口</div>
                    <div id="tokushima" class="prefecture-btn" data-prefecture="徳島県">徳島</div><div id="kagawa"    class="prefecture-btn" data-prefecture="香川県">香川</div>
                    <div id="ehime"     class="prefecture-btn" data-prefecture="愛媛県">愛媛</div><div id="kochi"     class="prefecture-btn" data-prefecture="高知県">高知</div>
                    <div id="fukuoka"   class="prefecture-btn" data-prefecture="福岡県">福岡</div><div id="saga"      class="prefecture-btn" data-prefecture="佐賀県">佐賀</div>
                    <div id="nagasaki"  class="prefecture-btn" data-prefecture="長崎県">長崎</div><div id="kumamoto"  class="prefecture-btn" data-prefecture="熊本県">熊本</div>
                    <div id="oita"      class="prefecture-btn" data-prefecture="大分県">大分</div><div id="miyazaki"  class="prefecture-btn" data-prefecture="宮崎県">宮崎</div>
                    <div id="kagoshima" class="prefecture-btn" data-prefecture="鹿児島県">鹿児島</div><div id="okinawa" class="prefecture-btn" data-prefecture="沖縄県">沖縄</div>
                </div>

             </div>
             <div class="mt-6 text-center">
                <button id="back-to-settings-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-6 rounded-full text-sm transition-colors">
                    設定に戻る
                </button>
             </div>
        </div>


        <div id="results-screen" class="screen hidden">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg text-center">
                <h1 class="text-3xl font-bold mb-4 font-rounded">クイズ結果</h1>
                <p class="text-5xl font-bold my-6"><span id="correct-answers-count"></span> / <span id="total-questions-count"></span></p>

                <div id="results-list" class="mt-8 text-left max-h-80 overflow-y-auto pr-2">
                    </div>

                <button id="restart-quiz-btn" class="mt-8 w-full max-w-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full text-lg transition-transform transform hover:scale-105">
                    もう一度挑戦する
                </button>
            </div>
        </div>

    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- グローバル変数・定数 ---
            const API_URL = 'cities.json'; 
            const PREFECTURES = [
                '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
                '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
                '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県',
                '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県',
                '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県',
                '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県',
                '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'
            ];
            let allCities = [];
            let filteredCities = [];
            let quizQuestions = [];
            let currentQuestionIndex = 0;
            let score = 0;
            let quizResults = [];
            let quizSettings = {
                questionCount: 20
            };

            // --- DOM要素 ---
            const screens = {
                loading: document.getElementById('loading-screen'),
                settings: document.getElementById('settings-screen'),
                quiz: document.getElementById('quiz-screen'),
                results: document.getElementById('results-screen')
            };
            const questionCountBtns = document.querySelectorAll('.question-count-btn');
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const filteredCitiesCountEl = document.getElementById('filtered-cities-count');
            const progressIndicatorEl = document.getElementById('progress-indicator');
            const feedbackMessageEl = document.getElementById('feedback-message');
            const cityNameQuestionEl = document.getElementById('city-name-question');
            const prefectureButtonsContainer = document.querySelector('.japan-map-grid');
            const correctAnswersCountEl = document.getElementById('correct-answers-count');
            const totalQuestionsCountEl = document.getElementById('total-questions-count');
            const resultsListEl = document.getElementById('results-list');
            const restartQuizBtn = document.getElementById('restart-quiz-btn');
            const backToSettingsBtn = document.getElementById('back-to-settings-btn');

            // --- スライダー要素 ---
            const sliders = {
                area: document.getElementById('area-slider'),
                population: document.getElementById('population-slider'),
                density: document.getElementById('density-slider')
            };
            const labels = {
                area: document.getElementById('area-range-label'),
                population: document.getElementById('population-range-label'),
                density: document.getElementById('density-range-label')
            };
            let sliderInstances = {};

            // --- 関数 ---

            // 画面切り替え
            const switchScreen = (screenName) => {
                Object.values(screens).forEach(screen => {
                    if (!screen.classList.contains('hidden')) {
                         screen.classList.add('hidden');
                    }
                });
                if (screens[screenName]) {
                    screens[screenName].classList.remove('hidden');
                }
            };

            // 数値をフォーマット (例: 10000 -> 1万)
            const formatNumber = (num) => {
                if (num >= 100000000) return `${(num / 100000000).toFixed(1)}億`;
                if (num >= 10000) return `${Math.round(num / 10000)}万`;
                return num.toLocaleString();
            };
            
            // スライダーの初期化
            const createSlider = (key, min, max, initialStart, initialEnd, step, format) => {
                const slider = sliders[key];
                const label = labels[key];

                sliderInstances[key] = noUiSlider.create(slider, {
                    start: [initialStart, initialEnd],
                    connect: true,
                    step: step,
                    range: { 'min': min, 'max': max },
                    format: {
                        to: value => Math.round(value),
                        from: value => Number(value)
                    }
                });
                
                sliderInstances[key].on('update', (values, handle) => {
                    label.textContent = `${format(values[0])} ~ ${format(values[1])}`;
                });
                sliderInstances[key].on('change', filterCities);
            };
            
            // 市区町村データのフィルタリング
            const filterCities = () => {
                if (!sliderInstances.area || !sliderInstances.population || !sliderInstances.density) {
                    return;
                }
                const [minArea, maxArea] = sliderInstances.area.get();
                const [minPop, maxPop] = sliderInstances.population.get();
                const [minDensity, maxDensity] = sliderInstances.density.get();

                filteredCities = allCities.filter(city => 
                    city.area >= minArea && city.area <= maxArea &&
                    city.population >= minPop && city.population <= maxPop &&
                    city.density >= minDensity && city.density <= maxDensity
                );
                
                filteredCitiesCountEl.textContent = filteredCities.length;
                startQuizBtn.disabled = filteredCities.length < quizSettings.questionCount;
            };

            // クイズ開始処理
            const startQuiz = () => {
                quizQuestions = [...filteredCities].sort(() => 0.5 - Math.random()).slice(0, quizSettings.questionCount);
                currentQuestionIndex = 0;
                score = 0;
                quizResults = [];
                switchScreen('quiz');
                askQuestion();
            };

            // 問題表示
            const askQuestion = () => {
                if (currentQuestionIndex >= quizQuestions.length) {
                    showResults();
                    return;
                }

                const buttons = prefectureButtonsContainer.querySelectorAll('.prefecture-btn');
                buttons.forEach(btn => {
                    btn.classList.remove('correct', 'incorrect', 'disabled');
                });
                feedbackMessageEl.textContent = '';
                feedbackMessageEl.classList.remove('correct-feedback', 'incorrect-feedback');

                const currentQuestion = quizQuestions[currentQuestionIndex];
                progressIndicatorEl.textContent = `${currentQuestionIndex + 1}問目 / ${quizQuestions.length}問`;
                cityNameQuestionEl.textContent = currentQuestion.city;
            };

            // 回答処理
            const handleAnswer = (e) => {
                const clickedButton = e.target.closest('.prefecture-btn');
                if (!clickedButton || clickedButton.classList.contains('disabled')) return;
                
                const selectedPrefecture = clickedButton.dataset.prefecture;
                const currentQuestion = quizQuestions[currentQuestionIndex];
                const isCorrect = selectedPrefecture === currentQuestion.prefecture;

                const buttons = prefectureButtonsContainer.querySelectorAll('.prefecture-btn');
                buttons.forEach(btn => btn.classList.add('disabled'));

                if (isCorrect) {
                    score++;
                    feedbackMessageEl.textContent = '正解！';
                    feedbackMessageEl.classList.add('correct-feedback');
                    clickedButton.classList.add('correct');
                } else {
                    feedbackMessageEl.textContent = `不正解... 正解は${currentQuestion.prefecture}`;
                    feedbackMessageEl.classList.add('incorrect-feedback');
                    clickedButton.classList.add('incorrect');
                    
                    const correctButton = prefectureButtonsContainer.querySelector(`[data-prefecture="${currentQuestion.prefecture}"]`);
                    if (correctButton) {
                        correctButton.classList.add('correct');
                    }
                }

                quizResults.push({
                    question: currentQuestion,
                    selected: selectedPrefecture,
                    isCorrect: isCorrect
                });
                
                currentQuestionIndex++;
                
                setTimeout(askQuestion, 1000); 
            };

            // 結果表示
            const showResults = () => {
                switchScreen('results');
                correctAnswersCountEl.textContent = score;
                totalQuestionsCountEl.textContent = quizQuestions.length;
                resultsListEl.innerHTML = '';
                quizResults.forEach((result, index) => {
                    const resultEl = document.createElement('div');
                    resultEl.classList.add('p-3', 'rounded-lg', 'mb-2', 'flex', 'items-center', 'justify-between');
                    resultEl.classList.add(result.isCorrect ? 'bg-green-100' : 'bg-red-100');
                    
                    const mapQuery = encodeURIComponent(`${result.question.prefecture} ${result.question.city}`);
                    const mapUrl = `https://www.google.com/maps?q=${mapQuery}`;

                    resultEl.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${index + 1}. ${result.question.city}</p>
                            <p class="text-sm text-gray-600">正解: ${result.question.prefecture} / あなたの回答: ${result.selected}</p>
                        </div>
                        <div class="flex items-center shrink-0 ml-4 space-x-4">
                            <a href="${mapUrl}" target="_blank" rel="noopener noreferrer" class="bg-white hover:bg-gray-100 text-gray-700 text-sm font-semibold py-1 px-3 border border-gray-300 rounded-full shadow-sm transition-colors">
                                地図を見る
                            </a>
                            <div class="text-2xl">
                                ${result.isCorrect ? '⭕️' : '❌'}
                            </div>
                        </div>
                    `;
                    resultsListEl.appendChild(resultEl);
                });
            };

            // クイズリセット
            const resetQuiz = () => {
                switchScreen('settings');
            };

            // --- 初期化処理 ---
            const initializeApp = async () => {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error('API request failed');
                    const rawData = await response.json();

                    allCities = rawData.map(d => ({
                        prefecture: d.prefecture,
                        city: d.city,
                        population: d.population,
                        area: d.area,
                        density: d.density,
                    })).filter(d => d.area > 0 && d.population > 0 && d.density > 0);

                    const maxArea = Math.ceil(Math.max(...allCities.map(c => c.area)));
                    const maxPopulation = Math.ceil(Math.max(...allCities.map(c => c.population)));
                    const maxDensity = Math.ceil(Math.max(...allCities.map(c => c.density)));

                    createSlider('area', 0, maxArea, 0, maxArea, 1, (v) => `${v.toLocaleString()} km²`);
                    createSlider('population', 0, maxPopulation, 0, maxPopulation, 1000, formatNumber);
                    createSlider('density', 0, maxDensity, 0, maxDensity, 100, (v) => v.toLocaleString());
                    
                    questionCountBtns.forEach(btn => {
                        btn.addEventListener('click', () => {
                            quizSettings.questionCount = parseInt(btn.dataset.questions, 10);
                            questionCountBtns.forEach(b => {
                                b.classList.remove('bg-blue-500', 'text-white');
                                b.classList.add('bg-gray-200', 'text-gray-800');
                            });
                            btn.classList.remove('bg-gray-200', 'text-gray-800');
                            btn.classList.add('bg-blue-500', 'text-white');
                            filterCities();
                        });
                    });
                    startQuizBtn.addEventListener('click', startQuiz);
                    restartQuizBtn.addEventListener('click', resetQuiz);
                    prefectureButtonsContainer.addEventListener('click', handleAnswer);
                    backToSettingsBtn.addEventListener('click', resetQuiz);
                    
                    filterCities();
                    switchScreen('settings');

                } catch (error) {
                    console.error("Initialization failed:", error);
                    screens.loading.innerHTML = '<p class="text-red-500">データの読み込みに失敗しました。cities.jsonファイルが同じフォルダに存在するか確認してください。</p>';
                }
            };
            
            initializeApp();
        });
    </script>

</body>
</html>